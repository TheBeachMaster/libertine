set -o errexit +o hashall

version 1.8.8
{
	depends musl-cross
	depends zlib
	depends linux-pam
	depends selinux
	include config "${settings_string[LFS_AUTOTOOLS_CONFIG_VERSION]}"
	
	make_fhs_folders_before_install var \
		lib/sudo \
		log/sudo \
		log/sudo/io
	
	setuid_binaries bin sudo sudoedit
	install_binaries bin sudo sudoedit sudoreplay
	install_system_binaries sbin visudo
}

function install_crosscompiler_sudo()
{
	local -r zlibRelativeInstallPath="$(dependencyPath zlib)"/install
	local -r zlibAbsoluteInstallPath="${LFS}${zlibRelativeInstallPath}"
		
	local -r prceRelativeInstallPath="$(dependencyPath pcre)"/install
	local -r prceAbsoluteInstallPath="${LFS}${prceRelativeInstallPath}"
	
	local -r linuxPamRelativeInstallPath="$(dependencyPath linux-pam)"/install
	local -r linuxPamAbsoluteInstallPath="${LFS}${linuxPamRelativeInstallPath}"
	
	local -r cracklibRelativeInstallPath="$(dependencyPath cracklib)"/install
	local -r cracklibAbsoluteInstallPath="${LFS}${cracklibRelativeInstallPath}"
	
	local -r busyboxBinRelativeInstallPath="$(dependencyPath busybox-bin)"/install
	local -r busyboxBinAbsoluteInstallPath="${LFS}${busyboxBinRelativeInstallPath}"

	local -r securePath="$(
		LFS_PHASE=system prepareZzzLfsPath
		echo -n "$LFS_DEPENDENCY_PATH_ZZZ"/sbinpath
		echo -n ":"
		echo -n "$LFS_DEPENDENCY_PATH_ZZZ"/binpath
	)"
	
	# NOTE: OPIE, S/Key and SecurID are not supported; these are effectively legacy technologies now that HOTP / TOTP (OATH) exist
	# TODO: Consider supporting Kerberos5
	# TODO: Support PAM
	
	buildUsingAutotoolsExternal callback_empty \
		--enable-pie \
		--disable-shared \
		--disable-rpath \
		--with-selinux \
		--with-pam \
		--with-incpath="$selinuxAbsoluteInstallPath/usr/include $linuxPamAbsoluteInstallPath/include" \
		--with-libpath="$selinuxAbsoluteInstallPath/usr/lib $prceAbsoluteInstallPath/lib $linuxPamAbsoluteInstallPath/lib $cracklibAbsoluteInstallPath/lib" \
		--with-libraries="selinux sepol pcre pam pamc pam_misc crack" \
		--enable-zlib="$zlibAbsoluteInstallPath" \
		--with-editor="$busyboxBinRelativeInstallPath"/vi:"$busyboxBinRelativeInstallPath"/ed \
		--with-secure-path="$securePath" \
		--with-sendmail="$busyboxBinRelativeInstallPath"/sendmail \
		--with-mail-if-no-user \
		--with-mail-if-no-host \
		--with-mail-if-noperms \
		--disable-root-mailer \
		--with-mailto="${settings_string[SUDO_MAIL_TO]}" \
		--with-mailsubject="${settings_string[SUDO_MAIL_SUBJECT]}" \
		--with-iologdir=/var/log/sudo/io \
		--with-logpath=/var/log/sudo/sudo.log \
		--with-timedir=/var/lib/sudo \
		--with-loglen=0 \
		--with-passprompt="${settings_string[SUDO_PASSWORD_PROMPT]}"
		--with-badpass-message="${settings_string[SUDO_BAD_PASSWORD_MESSAGE]}" \
		--disable-nls \
		--disable-admin-flag \
		--with-linux-audit \
		--with-man \
		--with-netsvc=no \
		--with-nsswitch=no \
		--without-AFS \
		--enable-shadow \
		--disable-sia \
		--enable-gss-krb5-ccache-name \
		--disable-path-info \
		--enable-noargs-shell \
		--with-badpri=warning \
		--with-goodpri=info \
		--with-ignore-dot \
		--without-lecture \
		--with-logfac=authpriv \
		--with-logging=syslog \
		--with-long-otp-prompt \
		--with-password-timeout=0 \
		--with-passwd-tries=3 \
		--with-sudoers-mode=0440
		--with-sudoers-uid=0 \
		--with-sudoers-gid=0 \
		--with-timeout=5 \
		--without-tty-tickets \
		--with-umask=0022
}
