# gcc pre-dependencies
sourceRecipe mpfr 3.1.2 toolchain1
sourceRecipe gmp 5.1.2 toolchain1
sourceRecipe mpc 1.0.1 toolchain1

addSourcePackageDownload 4.8.1 "$LFS_MIRROR_GNU"/"$LFS_SOURCE_PACKAGE_NAME"/"$LFS_SOURCE_PACKAGE_NAME"-4.8.1/"$LFS_SOURCE_PACKAGE_NAME"-4.8.1.tar.bz2 MD5:3b2386c114cd74185aa3754b58a79304

echo "$LFS_SOURCE_PACKAGE_NAME"

function installPackage_toolchain1_gcc()
{
	# TODO: These can be different versions to those used in the eventual system. Not good.
	extractDependencies mpfr:3.1.2 gmp:5.1.2 mpc:1.0.1

	# Adjust paths to use /tools and remove /usr/include
	local file
	for file in $(find gcc/config -name linux64.h -o -name linux.h -o -name sysv4.h)
	do
		cp -uv "$file"{,.orig}
		sed -e "s@/lib\(64\)\?\(32\)\?/ld@/${LFS_TOOLS}&@g" -e "s@/usr@/${LFS_TOOLS}@g" "$file".orig >"$file"
		echo '
#undef STANDARD_STARTFILE_PREFIX_1
#undef STANDARD_STARTFILE_PREFIX_2
#define STANDARD_STARTFILE_PREFIX_1 "/${LFS_TOOLS}/lib/"
#define STANDARD_STARTFILE_PREFIX_2 ""' >>"$file"
		touch $file.orig
	done

	# Stack protection
	sed -i '/k prot/agcc_cv_libc_provides_ssp=yes' gcc/configure

	createBuildFolderAndPushd

		local -r currentDir="$(pwd)"
		../"$ourExtractedTarballFolder"/configure        \
		--target="$LFS_TGT"                              \
		--prefix=/"$LFS_TOOLS"                                  \
		--with-sysroot="$LFS"                            \
		--with-newlib                                    \
		--without-headers                                \
		--with-local-prefix=/"$LFS_TOOLS"                       \
		--with-native-system-header-dir=/"$LFS_TOOLS"/include   \
		--disable-nls                                    \
		--disable-shared                                 \
		--disable-multilib                               \
		--disable-decimal-float                          \
		--disable-threads                                \
		--disable-libatomic                              \
		--disable-libgomp                                \
		--disable-libitm                                 \
		--disable-libmudflap                             \
		--disable-libquadmath                            \
		--disable-libsanitizer                           \
		--disable-libssp                                 \
		--disable-libstdc++-v3                           \
		--enable-languages=c,c++                         \
		--with-mpfr-include="$currentDir"/../"$ourExtractedTarballFolder"/mpfr/src \
		--with-mpfr-lib="$currentDir"/mpfr/src/.libs

		make

		make install

		# Using --disable-shared means that the libgcc_eh.a file isn't created and installed. The Glibc package depends on this library as it uses -lgcc_eh within its build system. This dependency can be satisfied by creating a symlink to libgcc.a, since that file will end up containing the objects normally contained in libgcc_eh.a: 
		ln -sv libgcc.a "$(${LFS_TGT}-gcc -print-libgcc-file-name | sed 's/libgcc/&_eh/')"

	popdAndRemoveBuilderFolder
}

function installPackage_toolchain2_gcc()
{
	cat gcc/limitx.h gcc/glimits.h gcc/limity.h >"$(dirname $("$LFS_TGT"-gcc -print-libgcc-file-name))"/include-fixed/limits.h
	
	cp -v gcc/Makefile.in{,.tmp}
	sed 's/^T_CFLAGS =$/& -fomit-frame-pointer/' gcc/Makefile.in.tmp >gcc/Makefile.in

	# Adjust paths to use /tools and remove /usr/include
	local file
	for file in $(find gcc/config -name linux64.h -o -name linux.h -o -name sysv4.h)
	do
		cp -uv "$file"{,.orig}
		sed -e 's@/lib\(64\)\?\(32\)\?/ld@/tools&@g' -e 's@/usr@/tools@g' "$file".orig >"$file"
		echo '
#undef STANDARD_STARTFILE_PREFIX_1
#undef STANDARD_STARTFILE_PREFIX_2
#define STANDARD_STARTFILE_PREFIX_1 "/tools/lib/"
#define STANDARD_STARTFILE_PREFIX_2 ""' >>"$file"
		touch $file.orig
	done
	
	extractDependencies mpfr gmp mpc
	
	createBuildFolderAndPushd
		
		local -r currentDir="$(pwd)"
		CC="$LFS_TGT"-gcc                                                          \
		CXX="$LFS_TGT"-g++                                                         \
		AR="$LFS_TGT"-ar                                                           \
		RANLIB="$LFS_TGT"-ranlib                                                   \
		../"$ourExtractedTarballFolder"/configure                                  \
		--prefix=/"$LFS_TOOLS"                                                            \
		--with-local-prefix=/"$LFS_TOOLS"                                                 \
		--with-native-system-header-dir=/"$LFS_TOOLS"/include                             \
		--enable-clocale=gnu                                                       \
		--enable-shared                                                            \
		--enable-threads=posix                                                     \
		--enable-__cxa_atexit                                                      \
		--enable-languages=c,c++                                                   \
		--disable-libstdcxx-pch                                                    \
		--disable-multilib                                                         \
		--disable-bootstrap                                                        \
		--disable-libgomp                                                          \
		--with-mpfr-include="$currentDir"/../"$ourExtractedTarballFolder"/mpfr/src \
		--with-mpfr-lib="$currentDir"/mpfr/src/.libs
		
		make
		
		make install
		
		ln -sv gcc /"$LFS_TOOLS"/bin/cc
		
	popdAndRemoveBuilderFolder
}
