set -o errexit +o hashall

version 4.8.1
{
	depends musl
	
	include mpfr 3.1.2
	include gmp 5.1.2
	include mpc 1.0.1
	include binutils 2.23.2
}

function installPackage_crosscompiler_gcc()
{
	local -r linuxInstallPath="${LFS}$(dependencyPath linux)"/install
	
	pushdDependencyFolder
		
		local dependencyName
		for dependencyName in mpfr gmp mpc
		do
			ln -sv ../"$dependencyName" "$dependencyName"
		done
		local binutilsFile
		for binutilsFile in ../binutils/*
		do
			# suppress existing entries
			ln -sv "$binutilsFile" 2>/dev/null || true
		done
		
		# Stack protection fix for glibc-2.18 / musl
		sed -i '/k prot/agcc_cv_libc_provides_ssp=yes' gcc/configure
		
		# Disable .info files
		sed -i 's/BUILD_INFO=info/BUILD_INFO=/' gcc/configure
		
		createBuildFolderAndPushd

			REALGCC="$LFS_TARGET"-gcc \
			CC="musl-gcc-external" \
			CXX="$LFS_TARGET"-g++ \
			CPPFLAGS="" \
			CFLAGS="-fPIC -Wall" \
			LDFLAGS="-Wl,-Bstatic -static-libgcc" \
			CXXFLAGS="" \
			AR="$LFS_TARGET"-ar \
			AS="$LFS_TARGET"-as \
			LD="$LFS_TARGET"-ld \
			NM="$LFS_TARGET"-nm \
			RANLIB="$LFS_TARGET"-ranlib \
			STRIP="$LFS_TARGET"-strip \
			OBJCOPY="$LFS_TARGET"-objcopy \
			OBJDUMP="$LFS_TARGET"-objdump \
			READELF="$LFS_TARGET"-readelf \
			../"$LFS_DEPENDENCY_NAME"/configure \
			--prefix="$LFS_DEPENDENCY_PREFIX_PATH" \
			--with-newlib \
			--without-headers \
			--with-local-prefix="$LFS_DEPENDENCY_PREFIX_PATH" \
			--with-native-system-header-dir="$linuxInstallPath"/usr/include \
			--enable-clocale=gnu \
			--disable-shared \
			--enable-threads=posix \
			--enable-__cxa_atexit \
			--disable-multilib \
			--disable-libmudflap \
			--disable-libsanitizer \
			--disable-libstdc++-v3 \
			--disable-libstdcxx-pch \
			--enable-ld \
			--disable-gold \
			--enable-languages=c \
			--disable-lto-plugin \
			--disable-bootstrap
		
			REALGCC="$LFS_TARGET"-gcc make

			REALGCC="$LFS_TARGET"-gcc make DESTDIR="$LFS" install

			# Using --disable-shared means that the libgcc_eh.a file isn't created and installed. The Glibc package depends on this library as it uses -lgcc_eh within its build system.
			# This dependency can be satisfied by creating a symlink to libgcc.a, since that file will end up containing the objects normally contained in libgcc_eh.a: 
		
			#local -r gcc=${LFS}${$LFS_DEPENDENCY_PREFIX_PATH}/bin/${LFS_TARGET}-gcc
			#ln -sv libgcc.a "$(${gcc} -print-libgcc-file-name | sed 's/libgcc/&_eh/')"

		popdBuildFolder
		

		# TOIDO: un"fix" headers
		# rm -rf "$CC_PREFIX/lib/gcc/$TRIPLE"/*/include-fixed/ "$CC_PREFIX/lib/gcc/$TRIPLE"/*/include/stddef.h
		
	
	popdDepdendencyFolder
}
