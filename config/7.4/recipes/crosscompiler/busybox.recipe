set -o errexit +o hashall

version 1.21.1
{
	depends musl-cross
	depends selinux
}

function install_crosscompiler_busybox()
{
	# libselinux depends on libpcre
	local -r prceRelativeInstallPath="$(dependencyPath pcre)"/install
	local -r prceAbsoluteInstallPath="${LFS}${prceRelativeInstallPath}"
	
	local -r selinuxRelativeInstallPath="$(dependencyPath selinux)"/install
	local -r selinuxAbsoluteInstallPath="${LFS}${selinuxRelativeInstallPath}"
		
	pushdDependencyFolder
		
		local -ir inclusiveUserId=${settings_integer[LFS_INCLUSIVE_USER_UID]}
		local -ir lastSystemId=$((inclusiveUserId-1))
		
		declare -A busyboxConfiguration
		busyboxConfiguration["CONFIG_CROSS_COMPILER_PREFIX"]="$LFS_C_TARGET_INTERNAL_PREFIX"
		busyboxConfiguration["CONFIG_SYSROOT"]="$LFS_C_TARGET_INTERNAL_SYS_ROOT"
		busyboxConfiguration["CONFIG_EXTRA_CFLAGS"]="-I${selinuxAbsoluteInstallPath}/usr/include"
		busyboxConfiguration["CONFIG_EXTRA_LDFLAGS"]="-L${selinuxAbsoluteInstallPath}/usr/lib -L${prceAbsoluteInstallPath}/lib -lpcre -lsepol -lselinux"
		busyboxConfiguration["CONFIG_PREFIX"]="$LFS_DEPENDENCY_INSTALL_PATH"
		busyboxConfiguration["CONFIG_FIRST_SYSTEM_ID"]="${settings_integer[LFS_INCLUSIVE_SYSTEM_UID]}"
		busyboxConfiguration["CONFIG_LAST_SYSTEM_ID"]="$lastSystemId"
		busyboxConfiguration["CONFIG_DEFAULT_MODULES_DIR"]="/lib/modules"
		busyboxConfiguration["CONFIG_FEATURE_CROND_DIR"]="/var/spool/cron"
		busyboxConfiguration["CONFIG_IFUPDOWN_IFSTATE_PATH"]="/var/run/ifstate"
		busyboxConfiguration["CONFIG_DHCPD_LEASES_FILE"]="/var/lib/misc/udhcpd.leases"
		busyboxConfiguration["CONFIG_UDHCPC_DEFAULT_SCRIPT"]="/usr/share/udhcpc/default.script"
		busyboxConfiguration["CONFIG_PREFIX"]="./_install"
		
		cp "$LFS_DEPENDENCY_PACKAGE_PATH"/config .config
		
		local key
		local value
		for key in "${!busyboxConfiguration[@]}"
		do
			value="${busyboxConfiguration["$key"]}"
			sed -i -e 's;^'${key}'=.*$;'${key}'="'"$value"'";g' .config
		done
		
		
		
		
		# bootstrap is a native compiler, but dynamically linked
		# the first $TRIPLE is a native compiler, but statically linked
		# we specify gcc / g++ from the first triple
		which gcc 1>&2
		which g++ 1>&2
		
		
		
		
		# CROSS_COMPILE means AS, CC, LD, CPP, AR, NM, STRIP, OBJCOPY, OBJDUMP, PKG_CONFIG (not used) should all be (a) on the path and (b) start with $CROSS_COMPILE and (c) deduced
		PATH="$PATH" \
		make \
			--jobs $LFS_MAKE__SYS_ROOT \
			--debug \
			V=2 \
			HOSTCC="$LFS_C_HOST_CC" \
			HOSTCXX="$LFS_C_HOST_CXX" \
			HOSTCFLAGS="$LFS_C_HOST_CFLAGS" \
			HOSTCXXFLAGS="$LFS_C_HOST_CXXFLAGS" \
			CROSS_COMPILE="$LFS_C_TARGET_EXTERNAL_PREFIX" \

		PATH="$PATH" \
		make \
			--jobs $LFS_MAKE__SYS_ROOT \
			V=2 \
			HOSTCC="$LFS_C_HOST_CC" \
			HOSTCXX="$LFS_C_HOST_CXX" \
			HOSTCFLAGS="$LFS_C_HOST_CFLAGS" \
			HOSTCXXFLAGS="$LFS_C_HOST_CXXFLAGS" \
			CROSS_COMPILE="$LFS_C_TARGET_EXTERNAL_PREFIX" \
		install
	
	popdDependencyFolder
}
