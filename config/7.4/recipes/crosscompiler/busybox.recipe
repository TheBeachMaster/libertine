set -o errexit +o hashall

version 1.21.1
{
	depends musl-cross
	depends selinux
}

function install_crosscompiler_busybox()
{
	# libselinux depends on libpcre
	local -r prceRelativeInstallPath="$(dependencyPath pcre)"/install
	local -r prceAbsoluteInstallPath="${LFS}${prceRelativeInstallPath}"
	
	local -r selinuxRelativeInstallPath="$(dependencyPath selinux)"/install
	local -r selinuxAbsoluteInstallPath="${LFS}${selinuxRelativeInstallPath}"
		
	pushdDependencyFolder
		
		local -ir inclusiveUserId=${settings_integer[LFS_INCLUSIVE_USER_UID]}
		local -ir lastSystemId=$((inclusiveUserId-1))
		
		declare -A busyboxConfiguration
		# "$LFS_TARGET"-like
		busyboxConfiguration["CONFIG_CROSS_COMPILER_PREFIX"]=""
		# $LFS_DEPENDENCY_INSTALL_PATH_MUSL_CROSS
		busyboxConfiguration["CONFIG_SYSROOT"]="$LFS_DEPENDENCY_INSTALL_PATH_MUSL_CROSS"/"$LFS_TARGET"
		busyboxConfiguration["CONFIG_EXTRA_CFLAGS"]="-I${selinuxAbsoluteInstallPath}/usr/include"
		busyboxConfiguration["CONFIG_EXTRA_LDFLAGS"]="-L${selinuxAbsoluteInstallPath}/usr/lib -L${prceAbsoluteInstallPath}/lib -lpcre -lsepol -lselinux"
		busyboxConfiguration["CONFIG_PREFIX"]="$LFS_DEPENDENCY_INSTALL_PATH"
		busyboxConfiguration["CONFIG_FIRST_SYSTEM_ID"]="${settings_integer[LFS_INCLUSIVE_SYSTEM_UID]}"
		busyboxConfiguration["CONFIG_LAST_SYSTEM_ID"]="$lastSystemId"
		busyboxConfiguration["CONFIG_DEFAULT_MODULES_DIR"]="/lib/modules"
		busyboxConfiguration["CONFIG_FEATURE_CROND_DIR"]="/var/spool/cron"
		busyboxConfiguration["CONFIG_IFUPDOWN_IFSTATE_PATH"]="/var/run/ifstate"
		busyboxConfiguration["CONFIG_DHCPD_LEASES_FILE"]="/var/lib/misc/udhcpd.leases"
		busyboxConfiguration["CONFIG_UDHCPC_DEFAULT_SCRIPT"]="/usr/share/udhcpc/default.script"
		busyboxConfiguration["CONFIG_PREFIX"]="./_install"
		
		cp "$LFS_DEPENDENCY_PACKAGE_PATH"/config .config
		
		local key
		local value
		for key in "${!busyboxConfiguration[@]}"
		do
			value="${busyboxConfiguration["$key"]}"
			sed -i -e 's;^'${key}'=.*$;'${key}'="'"$value"'";g' .config
		done
		
		# LFS_CFLAGS_PRE=-static make scripts_basic

		local -r cCompiler=external-crosscompiler-gcc
		local -r cxxCompiler=external-crosscompiler-g++
		
		LFS_CFLAGS_PRE="-v -static" makeWrapper "$cCompiler" "$cxxCompiler" scripts_basic
		
		LFS_CFLAGS_PRE=-static makeWrapper "$cCompiler" "$cxxCompiler" busybox
		
		makeWrapper "$cCompiler" "$cxxCompiler" install
	
	popdDependencyFolder
}
