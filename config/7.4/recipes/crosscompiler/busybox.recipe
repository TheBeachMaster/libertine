set -o errexit +o hashall

version 1.21.1
{
	depends musl-cross
	depends selinux
	depends oniguruma
}

function install_crosscompiler_busybox()
{
	# libselinux depends on libpcre
	local -r prceRelativeInstallPath="$(dependencyPath pcre)"/install
	local -r prceAbsoluteInstallPath="${LFS}${prceRelativeInstallPath}"
	
	# busybox selinux functionality
	local -r selinuxRelativeInstallPath="$(dependencyPath selinux)"/install
	local -r selinuxAbsoluteInstallPath="${LFS}${selinuxRelativeInstallPath}"
	
	# busybox vi regex functionality assumes gnu regex, which oniguruma provides
	local -r onigurumaRelativeInstallPath="$(dependencyPath oniguruma)"/install
	local -r onigurumaAbsoluteInstallPath="${LFS}${onigurumaRelativeInstallPath}"
	
	pushdDependencyFolder
		
		local -ir inclusiveUserId=${settings_integer[LFS_INCLUSIVE_USER_UID]}
		local -ir lastSystemId=$((inclusiveUserId-1))
		
		declare -A busyboxConfiguration
		declare -A busyboxConfigurationInteger
		busyboxConfiguration["CONFIG_CROSS_COMPILER_PREFIX"]="$LFS_C_TARGET_EXTERNAL_PREFIX"
		busyboxConfiguration["CONFIG_SYSROOT"]="$LFS_C_TARGET_EXTERNAL_SYS_ROOT"
		busyboxConfiguration["CONFIG_EXTRA_CFLAGS"]="-I${selinuxAbsoluteInstallPath}/usr/include -I${onigurumaAbsoluteInstallPath}/include"
		busyboxConfiguration["CONFIG_EXTRA_LDFLAGS"]="-L${selinuxAbsoluteInstallPath}/usr/lib -L${prceAbsoluteInstallPath}/lib -L${onigurumaAbsoluteInstallPath}/lib"
		busyboxConfiguration["CONFIG_EXTRA_LDLIBS"]="-lpcre -lsepol -lselinux -lonig"
		busyboxConfiguration["CONFIG_PREFIX"]="$LFS_DEPENDENCY_INSTALL_PATH"
		busyboxConfiguration["CONFIG_DEFAULT_MODULES_DIR"]="/lib/modules"
		busyboxConfiguration["CONFIG_FEATURE_CROND_DIR"]="/var/spool/cron"
		busyboxConfiguration["CONFIG_IFUPDOWN_IFSTATE_PATH"]="/var/run/ifstate"
		busyboxConfiguration["CONFIG_DHCPD_LEASES_FILE"]="/var/lib/misc/udhcpd.leases"
		busyboxConfiguration["CONFIG_UDHCPC_DEFAULT_SCRIPT"]="/usr/share/udhcpc/default.script"
		busyboxConfiguration["CONFIG_PREFIX"]="./_install"

		declare -A busyboxConfigurationInteger
		busyboxConfigurationInteger["CONFIG_FIRST_SYSTEM_ID"]="${settings_integer[LFS_INCLUSIVE_SYSTEM_UID]}"
		busyboxConfigurationInteger["CONFIG_LAST_SYSTEM_ID"]="$lastSystemId"
		
		cp "$LFS_DEPENDENCY_PACKAGE_PATH"/config .config
		
		local key
		local value
		for key in "${!busyboxConfiguration[@]}"
		do
			value="${busyboxConfiguration["$key"]}"
			sed -i -e 's;^'${key}'=.*$;'${key}'="'"$value"'";g' .config
		done
		
		for key in "${!busyboxConfigurationInteger[@]}"
		do
			value="${busyboxConfigurationInteger["$key"]}"
			sed -i -e 's;^'${key}'=.*$;'${key}'='${value}';g' .config
		done
		
		# We use oniguruma to provide gnu regexes, as these are missing from musl libc
		pushd editors >/dev/null
			cp vi.c vi.c.orig
			sed -i -e 's;^# include <regex.h>;# include <oniggnu.h>\n# include <onigposix.h>;g' vi.c
		popd >/dev/null
		
		
		# -Wno-cpp suppresses errors about redirections in std c lib headers
		
		
		
		# Setting CROSS_COMPILE means AS, CC, LD, CPP, AR, NM, STRIP, OBJCOPY, OBJDUMP and PKG_CONFIG are all set to ${CROSS_COMPILE}PROGNAME, and so should be on the path
		#  - Does not seem to use TARGETCC despite using HOSTCC
		# HOSTLDFLAGS are from the perspective of CC (not LD); they are used for linking
		#  - Busybox, based on the Linux Kconfig system, does not re-use CFLAGS (or CXXFLAGS) when linking to create host executables
		#  - LD is actually CC or CXX
		#  - HOSTLDFLAGS may be used with either CC or CXX when linking
		#  - HOST_LOADLIBES is used for libraries to link, eg -ldl, and comes AFTER the object list (which is very sane)
		#  - Also HOST_EXTRACFLAGS, HOST_EXTRACXXFLAGS, HOST_EXTRACFLAGS_xxx, HOST_EXTRACXXFLAGS_xxx, HOST_LOADLIBES, HOST_LOADLIBES_xxx, HOST_LDFLAGS, HOST_LLD
		#  - _xxx are specific targets, eg _conf and _conf.o 
		PATH="$PATH" \
		make \
			--jobs 1 \
			--debug \
			--print-directory \
			V=2 \
			HOSTCC="$LFS_C_HOST_CC" \
			HOSTCXX="$LFS_C_HOST_CXX" \
			HOSTLD="$LFS_C_HOST_LD" \
			HOSTCFLAGS="$LFS_C_HOST_CFLAGS" \
			HOSTCXXFLAGS="$LFS_C_HOST_CXXFLAGS" \
			HOSTLDFLAGS="$LFS_C_HOST_CFLAGS" \
			CROSS_COMPILE="$LFS_C_TARGET_EXTERNAL_PREFIX" \
			CFLAGS="$LFS_C_TARGET_EXTERNAL_CFLAGS -Wno-cpp ${busyboxConfiguration["CONFIG_EXTRA_CFLAGS"]}" \
		all

		PATH="$PATH" \
		make \
			--jobs $LFS_MAKE_JOBS \
			V=2 \
			HOSTCC="$LFS_C_HOST_CC" \
			HOSTCXX="$LFS_C_HOST_CXX" \
			HOSTLD="$LFS_C_HOST_LD" \
			HOSTCFLAGS="$LFS_C_HOST_CFLAGS" \
			HOSTCXXFLAGS="$LFS_C_HOST_CXXFLAGS" \
			HOSTLDFLAGS="$LFS_C_HOST_CFLAGS" \
			CROSS_COMPILE="$LFS_C_TARGET_EXTERNAL_PREFIX" \
			CFLAGS="$LFS_C_TARGET_EXTERNAL_CFLAGS -Wno-cpp" \
		install
	
	popdDependencyFolder
}
