set -o errexit +o hashall

version 2.18
{
	depends linux
}

function installPackage_crosscompiler_glibc()
{
	# This is a special case break-out from root
	if [ ! -r /usr/include/rpc/types.h ]; then
		mkdir -p /usr/include/rpc
		cp -v sunrpc/rpc/*.h /usr/include/rpc
	fi
	
	sed -i -e 's/static __m128i/inline &/' sysdeps/x86_64/multiarch/strstr.c
	
	createBuildFolderAndPushd
		
		../"$LFS_RECIPE_EXTRACTED_TARBALL_FOLDER"/configure                         \
		--prefix=/"$LFS_TOOLS"                                                   \
		--host="$LFS_TGT"                                                 \
		--build="$(../"$LFS_RECIPE_EXTRACTED_TARBALL_FOLDER"/scripts/config.guess)" \
		--disable-profile                                                 \
		--enable-kernel=2.6.32                                            \
		--with-headers=/"$LFS_TOOLS"/include                                     \
		libc_cv_forced_unwind=yes                                         \
		libc_cv_ctors_header=yes                                          \
		libc_cv_c_cleanup=yes
		
		make
		
		make install
		
	popdBuildFolder
	
	localPackage_crosscompiler_glibc_verifyGlibc
}

function localPackage_crosscompiler_glibc_verifyGlibc()
{
	echo 'main(){}' >dummy.c
	"$LFS_TGT"-gcc dummy.c
	local -r interpreter="$(readelf -l a.out | awk -v FS=': ' -v ORS='' 'NR==1, $0 ~ /Requesting program interpreter/ {print $2}')"
	
	case "$(uname -m)" in
		x86_64)
			local -r libraryFolderName=lib64
		;;
		
		*)
			local -r libraryFolderName=lib
		;;
	esac
	
	if [ "$(purebash_dirname "$interpreter")" != /"$LFS_TOOLS"/"$libraryFolderName" ]; then
		echo "$interpreter is incorrect"
		exit 3
	fi
	
	rm -f -v dummy.c a.out
}
