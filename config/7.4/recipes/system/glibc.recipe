set -o errexit +o hashall

version 2.18
{
	depends man-pages
	
	touch_file /etc/ld.so.conf 644 root root js ai
	directory /etc/ld.so.conf.d 755 root root js ai
	touch_file /etc/ld.so.conf.d/libc.conf 644 root root js ai
	
	directory /usr/lib/locale 755 root root '' ai
	
	touch_file /etc/nsswitch.conf 644 root root js ai
	
	# Installation of minimum set of locales for test coverage
	permissions_after /usr/lib/locale/locale-archive 644 root root js ai
}

function install_system_glibc()
{
	# -nostdinc and -iquote and --with-headers=/"$LFS_TOOLS"/include 
	
	sed -i -e 's/static __m128i/inline &/' sysdeps/x86_64/multiarch/strstr.c
	
	createBuildFolderAndPushd
		
		../"$LFS_RECIPE_EXTRACTED_TARBALL_FOLDER"/configure    \
		--prefix=/usr          \
		--disable-profile      \
		--enable-kernel=2.6.32 \
		--libexecdir=/usr/lib/glibc
		
		#mkdir -m 0755 -p "$LFS_INSTALL_LOCATION"
		#CC=XXXXX CFLAGS="gcc -Wl,-dynamic-linker,/my/lib/ld-linux.so.2" ../"$LFS_RECIPE_EXTRACTED_TARBALL_FOLDER"/configure    \
		#--prefix="$LFS_INSTALL_LOCATION"        \
		#--with-headers="$LFS_INSTALL_LOCATION_LINUX"        \
		#--disable-profile      \
		#--enable-kernel=3.10.10
		#--enable-lock-elision=yes
		#--with-binutils=/"$LFS_TOOLS"/bin
		# Location of binutils not needed if we use the PATH, but I'd rather not do that
		
		make
		
		#TIMEOUTFACTOR=16 make -k check || true
		
		# Use install_root=/path/to/install rather than DESTDIR
		make install
		
		# Install of NIS and RPC headers not installed by default
		cp -v ../"$LFS_RECIPE_EXTRACTED_TARBALL_FOLDER"/sunrpc/rpc/*.h /usr/include/rpc
		cp -v ../"$LFS_RECIPE_EXTRACTED_TARBALL_FOLDER"/sunrpc/rpcsvc/*.h /usr/include/rpcsvc
		cp -v ../"$LFS_RECIPE_EXTRACTED_TARBALL_FOLDER"/nis/rpcsvc/*.h /usr/include/rpcsvc
		
		# Or use glibc-2.18/localedata/SUPPORTED with  make localedata/install-locales
		if [ ${settings_binary[LFS_LOCALE_INSTALL_ALL]} -eq 1 ]; then
			make localedata/install-locales
		else
			local localeCommand
			for localeCommand in "${settings_locale_Commands[@]}"
			do
				eval $localeCommand
			done
		fi
		
		cat >>/etc/nsswitch.conf <<-'EOF'
			# /etc/nsswitch.conf
			#
			# Example configuration of GNU Name Service Switch functionality.
			# If you have the `glibc-doc-reference' and `info' packages installed, try:
			# `info libc "Name Service Switch"' for information about this file.
			
			# on ubuntu, these are set to 'compat'
			passwd: files
			group: files
			shadow: files

			hosts: files dns
			networks: files

			# on ubuntu, these are set to 'db files'
			protocols: files
			services: files
			ethers: files
			rpc: files
			
			# on ubuntu only
			#netgroup: nis
		EOF
		
		cat >>/etc/ld.so.conf <<-EOF
			include /etc/ld.so.conf.d/*.conf
			
		EOF
		
		cat >>/etc/ld.so.conf.d/libc.conf <<-EOF
			/usr/local/lib
		EOF
		
	popdBuildFolder
}
